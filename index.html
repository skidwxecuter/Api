<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard with Leaderboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Iconify for icons -->
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        .rank-1 { background-color: #ffd700 !important; }
        .rank-2 { background-color: #c0c0c0 !important; }
        .rank-3 { background-color: #cd7f32 !important; }
        .leaderboard-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .table-hover tbody tr:hover {
            transform: scale(1.01);
            transition: transform 0.2s ease;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Your existing charts would go here -->
        
        <!-- Leaderboard Card -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Top Performers</h5>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="leaderboardFilter" data-bs-toggle="dropdown" aria-expanded="false">
                        This Week
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="leaderboardFilter">
                        <li><a class="dropdown-item" href="#" data-period="week">This Week</a></li>
                        <li><a class="dropdown-item" href="#" data-period="month">This Month</a></li>
                        <li><a class="dropdown-item" href="#" data-period="all">All Time</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="leaderboardTable">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 60px;">Rank</th>
                                <th>User</th>
                                <th class="text-end">Hits</th>
                                <th class="text-end">Clicks</th>
                                <th class="text-end">Accounts</th>
                                <th class="text-end">Robux</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Leaderboard data will be loaded here -->
                            <tr>
                                <td colspan="7" class="text-center py-4">Loading leaderboard data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    $(document).ready(function() {
        // Check if charts exist on the page
        if (document.getElementById('weeklyActivityChart') && document.getElementById('visitsBarChart') && 
            document.getElementById('clicksBarChart') && document.getElementById('accountsBarChart') && 
            document.getElementById("chart")) {
            
            // Fetch data from API
            $.ajax({
                url: "/api/chart?type=Regular",
                method: "POST",
                headers: {
                    "content-type": "application/json"
                },
                complete: function(data) {
                    // Update your existing charts here
                    $($('.fw-medium.text-sm.text-primary-light.mt-12.mb-0.d-flex.align-items-center.gap-2')[1]).html(`
                        <span class="d-inline-flex align-items-center gap-1 text-${data.responseJSON['data']['account']['difference'] > 0 ? 'success' : 'danger'}-main">
                            <iconify-icon icon="bxs:${data.responseJSON['data']['account']['difference'] > 0 ? 'up' : 'down'}-arrow" class="text-xs"></iconify-icon> 
                            ${data.responseJSON['data']['account']['percent_change']}% (${Number(data.responseJSON['data']['account']['difference']).toLocaleString()})
                        </span> 
                        â€¢ +${Number(data.responseJSON['data']['account']['today']).toLocaleString()} today
                    `);
                    
                    // Similar updates for other charts...

                    // Populate leaderboard if data exists
                    if (data.responseJSON.leaderboard) {
                        populateLeaderboard(data.responseJSON.leaderboard);
                    } else {
                        // If no leaderboard data, show a message
                        $('#leaderboardTable tbody').html(`
                            <tr>
                                <td colspan="7" class="text-center py-4">No leaderboard data available</td>
                            </tr>
                        `);
                    }
                },
                error: function() {
                    $('#leaderboardTable tbody').html(`
                        <tr>
                            <td colspan="7" class="text-center py-4 text-danger">Failed to load leaderboard data</td>
                        </tr>
                    `);
                }
            });
        }

        // Leaderboard filter dropdown
        $(document).on('click', '.dropdown-item[data-period]', function(e) {
            e.preventDefault();
            const period = $(this).data('period');
            $('#leaderboardFilter').text($(this).text());
            
            // Here you would typically make another AJAX call to get filtered data
            // For now, we'll just show a loading message
            $('#leaderboardTable tbody').html(`
                <tr>
                    <td colspan="7" class="text-center py-4">Loading ${period} data...</td>
                </tr>
            `);
            
            // Simulate loading new data (replace with actual AJAX call)
            setTimeout(() => {
                // This would be replaced with actual API call
                // $.ajax({...}).then(function(data) { populateLeaderboard(data.leaderboard); });
                
                // For demo, we'll just show a message
                $('#leaderboardTable tbody').html(`
                    <tr>
                        <td colspan="7" class="text-center py-4">Would load ${period} data here</td>
                    </tr>
                `);
            }, 1000);
        });
    });

    function populateLeaderboard(leaderboardData) {
        const tbody = $('#leaderboardTable tbody');
        tbody.empty();
        
        // Sort by total score (or your preferred metric)
        leaderboardData.sort((a, b) => (b.total || (b.hits + b.clicks + b.accounts + b.robux)) - 
                                      (a.total || (a.hits + a.clicks + a.accounts + a.robux)));
        
        // Add each user to the leaderboard
        leaderboardData.forEach((user, index) => {
            const rank = index + 1;
            const totalScore = user.total || (user.hits + user.clicks + user.accounts + user.robux);
            
            const row = $(`
                <tr class="${rank <= 3 ? 'rank-' + rank : ''}">
                    <td class="text-center fw-bold">${rank}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${user.avatar || 'https://www.roblox.com/Thumbs/Avatar.ashx?x=150&y=150&username=' + encodeURIComponent(user.username)}" 
                                 class="leaderboard-avatar" alt="${user.username}">
                            <span>${user.username}</span>
                        </div>
                    </td>
                    <td class="text-end">${user.hits ? user.hits.toLocaleString() : '0'}</td>
                    <td class="text-end">${user.clicks ? user.clicks.toLocaleString() : '0'}</td>
                    <td class="text-end">${user.accounts ? user.accounts.toLocaleString() : '0'}</td>
                    <td class="text-end">${user.robux ? user.robux.toLocaleString() : '0'}</td>
                    <td class="text-end fw-bold">${totalScore.toLocaleString()}</td>
                </tr>
            `);
            
            tbody.append(row);
        });
        
        // If no data, show message
        if (leaderboardData.length === 0) {
            tbody.html(`
                <tr>
                    <td colspan="7" class="text-center py-4">No users found in the leaderboard</td>
                </tr>
            `);
        }
    }
    </script>
</body>
</html>
