<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Pastebin</title>
  <style>
    body { background: #111; color: #0f0; font-family: monospace; padding: 20px; }
    input, textarea { width: 100%; margin: 5px 0; font-size: 16px; padding: 8px; }
    button { background: #0f0; color: #000; border: none; padding: 10px 20px; margin-top: 10px; cursor: pointer; }
    a { color: #0f0; }
    .paste { border-bottom: 1px solid #0f0; padding: 10px 0; }
    #viewer { display: none; }
    #comments { margin-top: 20px; border-top: 1px solid #0f0; padding-top: 10px; }
    .comment { border-bottom: 1px dashed #0f0; margin-bottom: 5px; }
  </style>
</head>
<body>

  <h1 id="siteTitle">üìÑ My Pastebin</h1>

  <div id="creator">
    <input id="title" placeholder="Title"><br>
    <textarea id="content" placeholder="Content"></textarea><br>
    <button onclick="createPaste()">Create Paste</button><br><br>
    <input id="search" placeholder="Search..." oninput="loadPastes()">
    <div id="pastes"></div>
  </div>

  <div id="viewer">
    <h2 id="pasteTitle"></h2>
    <p><strong>Views:</strong> <span id="pasteViews"></span> | <strong>Likes:</strong> <span id="pasteLikes"></span>
      <button onclick="likePaste()">üëç Like</button></p>
    <pre id="pasteContent"></pre>
    <button onclick="goHome()">‚¨ÖÔ∏è Back</button>
    <p>üîó Raw Link: <a id="rawLink" href="#" target="_blank">View Raw</a></p>

    <div id="comments">
      <h3>Comments</h3>
      <div id="commentList"></div>
      <textarea id="newComment" placeholder="Add a comment..."></textarea><br>
      <button onclick="addComment()">Comment</button>
    </div>
  </div>

  <script>
    const API = 'https://api-90xm.onrender.com';
    let currentId = null;

    async function createPaste() {
      const title = document.getElementById('title').value.trim();
      const content = document.getElementById('content').value.trim();
      if (!title || !content) return alert('Please fill in both fields!');
      const res = await fetch(`${API}/api/paste`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ title, content })
      });
      const data = await res.json();
      const link = `${location.origin}${location.pathname}?id=${data.id}`;
      const raw = `${link}&raw`;
      alert(`Paste created!\nView: ${link}\nRaw: ${raw}`);
      document.getElementById('title').value = '';
      document.getElementById('content').value = '';
      loadPastes();
    }

    async function loadPastes() {
      const res = await fetch(`${API}/api/pastes`);
      const pastes = await res.json();
      const q = document.getElementById('search').value.toLowerCase();
      const filtered = pastes.filter(p => p.title.toLowerCase().includes(q));
      document.getElementById('pastes').innerHTML = filtered.map(p =>
        `<div class="paste">
          <a href="?id=${p.id}">${p.title}</a><br>
          <small>${new Date(p.createdAt).toLocaleString()} ‚Äî ${p.views} views</small>
        </div>`
      ).join('');
    }

    async function viewPaste(id, isRaw) {
      currentId = id;
      const res = await fetch(`${API}/api/paste/${id}`);
      const paste = await res.json();

      if (isRaw) {
        document.head.innerHTML = '<meta charset="UTF-8">';
        document.body.innerHTML = `<pre>${paste.content}</pre>`;
        return;
      }

      document.getElementById('siteTitle').textContent = paste.title;
      document.getElementById('pasteTitle').textContent = paste.title;
      document.getElementById('pasteViews').textContent = paste.views;
      document.getElementById('pasteLikes').textContent = paste.likes || 0;
      document.getElementById('pasteContent').textContent = paste.content;
      document.getElementById('rawLink').href = `${location.origin}${location.pathname}?id=${paste.id}&raw`;

      const saved = JSON.parse(localStorage.getItem(`comments-${id}`) || "[]");
      renderComments(saved);

      document.getElementById('creator').style.display = 'none';
      document.getElementById('viewer').style.display = 'block';
    }

    function goHome() {
      history.pushState({}, '', location.pathname);
      document.getElementById('siteTitle').textContent = "üìÑ My Pastebin";
      document.getElementById('creator').style.display = 'block';
      document.getElementById('viewer').style.display = 'none';
      loadPastes();
    }

    function likePaste() {
      const likesKey = `likes-${currentId}`;
      let likes = parseInt(localStorage.getItem(likesKey) || "0");
      likes++;
      localStorage.setItem(likesKey, likes);
      document.getElementById('pasteLikes').textContent = likes;
    }

    function renderComments(comments) {
      document.getElementById('commentList').innerHTML = comments.map(c =>
        `<div class="comment">${c}</div>`
      ).join('');
    }

    function addComment() {
      const box = document.getElementById('newComment');
      const text = box.value.trim();
      if (!text) return;
      const key = `comments-${currentId}`;
      const comments = JSON.parse(localStorage.getItem(key) || "[]");
      comments.push(text);
      localStorage.setItem(key, JSON.stringify(comments));
      renderComments(comments);
      box.value = '';
    }

    // Route
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const isRaw = params.has('raw');
    if (id) viewPaste(id, isRaw);
    else loadPastes();
  </script>

</body>
</html>
